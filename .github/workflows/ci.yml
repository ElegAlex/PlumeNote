name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================================================
  # Type Check
  # ==========================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: |
          npm run build --workspace=@plumenote/types
          npm run db:generate --workspace=@plumenote/database
          npm run build --workspace=@plumenote/database

      # Note: Lint désactivé - pas de config ESLint dans le projet
      # - name: Lint
      #   run: npm run lint --workspaces --if-present

      - name: Type check
        run: npm run typecheck --workspaces --if-present

  # ==========================================================================
  # Unit Tests
  # ==========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: |
          npm run build --workspace=@plumenote/types
          npm run db:generate --workspace=@plumenote/database
          npm run build --workspace=@plumenote/database

      - name: Run tests
        run: npm run test --workspaces --if-present

  # ==========================================================================
  # Build Applications
  # ==========================================================================
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all
        run: |
          npm run build --workspace=@plumenote/types
          npm run db:generate --workspace=@plumenote/database
          npm run build --workspace=@plumenote/database
          npm run build --workspace=@plumenote/api
          npm run build --workspace=@plumenote/yjs-server
          npm run build --workspace=@plumenote/web

      - name: Verify builds
        run: |
          test -f apps/api/dist/index.js || exit 1
          test -f apps/yjs-server/dist/index.js || exit 1
          test -d apps/web/dist || exit 1
          echo "✓ All builds successful"

  # ==========================================================================
  # Docker Build
  # ==========================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [typecheck, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: false
          tags: plumenote-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build YJS image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/yjs-server/Dockerfile
          push: false
          tags: plumenote-yjs:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: false
          tags: plumenote-web:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # Integration Tests (Docker Compose)
  # ==========================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create .env file
        run: |
          cat > docker/.env << 'EOF'
          NODE_ENV=production
          DOMAIN=localhost
          POSTGRES_USER=plumenote
          POSTGRES_PASSWORD=testpassword123
          POSTGRES_DB=plumenote
          REDIS_PASSWORD=testredispassword123
          JWT_SECRET=JwtTestSecretForCI32CharactersMinimum
          COOKIE_SECRET=CookieTestSecretForCI32CharactersMin
          CORS_ORIGINS=http://localhost
          HTTP_PORT=80
          HTTPS_PORT=443
          ENABLE_SSL=false
          SEED_DATABASE=true
          EOF

      - name: Start services
        run: |
          cd docker
          docker compose up -d --build
          sleep 60  # Attendre que tous les services démarrent

      - name: Check services health
        run: |
          cd docker
          docker compose ps
          # Vérifier que les services critiques sont up
          docker compose ps | grep -q "plumenote-api.*Up" || exit 1
          docker compose ps | grep -q "plumenote-yjs.*Up" || exit 1
          docker compose ps | grep -q "plumenote-web.*Up" || exit 1
          docker compose ps | grep -q "plumenote-postgres.*Up" || exit 1
          docker compose ps | grep -q "plumenote-redis.*Up" || exit 1

      - name: Run smoke tests
        run: |
          cd docker
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh http://localhost

      - name: Show logs on failure
        if: failure()
        run: |
          cd docker
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          cd docker
          docker compose down -v
